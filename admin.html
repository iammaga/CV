<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель CV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-bg': '#1a1a1a',
                        'card-bg': '#2a2a2a',
                        'orange-accent': '#ff6b35',
                        'orange-light': '#f7931e'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        * { scrollbar-width: thin; scrollbar-color: #ff6b35 #2a2a2a; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2a2a2a; }
        ::-webkit-scrollbar-thumb { background: #ff6b35; border-radius: 4px; }
        .loader { border: 3px solid #2a2a2a; border-top: 3px solid #ff6b35; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        textarea { resize: vertical; min-height: 100px; }
        .tab-active { border-bottom: 2px solid #ff6b35; color: #ff6b35; }
    </style>
</head>
<body class="bg-dark-bg text-white font-sans min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-card-bg rounded-2xl p-8 max-w-md w-full">
            <h1 class="text-2xl font-bold mb-2 text-center">Админ-панель CV</h1>
            <p class="text-gray-400 text-sm mb-6 text-center">Введите GitHub Personal Access Token для авторизации</p>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">GitHub PAT</label>
                    <input type="password" id="tokenInput"
                        class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-3 focus:border-orange-accent focus:outline-none transition"
                        placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                </div>

                <button onclick="login()"
                    class="w-full bg-gradient-to-r from-orange-accent to-orange-light text-white font-semibold py-3 rounded-lg hover:opacity-90 transition">
                    Войти
                </button>

                <p id="loginError" class="text-red-500 text-sm text-center hidden"></p>

                <div class="text-gray-500 text-xs mt-4">
                    <p class="mb-2">Как получить токен:</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>GitHub Settings -> Developer settings</li>
                        <li>Personal access tokens -> Tokens (classic)</li>
                        <li>Generate new token с правами <code class="bg-dark-bg px-1 rounded">repo</code></li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">
        <!-- Header -->
        <header class="bg-card-bg border-b border-gray-700 sticky top-0 z-50">
            <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
                <h1 class="text-xl font-bold">Админ-панель CV</h1>
                <div class="flex items-center gap-4">
                    <span id="saveStatus" class="text-sm text-gray-400"></span>
                    <button onclick="saveData()" id="saveBtn"
                        class="bg-gradient-to-r from-orange-accent to-orange-light text-white px-6 py-2 rounded-lg font-medium hover:opacity-90 transition flex items-center gap-2">
                        <span>Сохранить</span>
                        <div id="saveLoader" class="loader hidden"></div>
                    </button>
                    <button onclick="logout()" class="text-gray-400 hover:text-white transition">
                        Выйти
                    </button>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <nav class="bg-card-bg border-b border-gray-700">
            <div class="max-w-6xl mx-auto px-4 flex gap-6">
                <button onclick="showTab('profile')" class="tab-btn py-4 text-sm font-medium tab-active" data-tab="profile">Профиль</button>
                <button onclick="showTab('stats')" class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-white" data-tab="stats">Статистика</button>
                <button onclick="showTab('experience')" class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-white" data-tab="experience">Опыт работы</button>
                <button onclick="showTab('skills')" class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-white" data-tab="skills">Навыки</button>
                <button onclick="showTab('translations')" class="tab-btn py-4 text-sm font-medium text-gray-400 hover:text-white" data-tab="translations">Переводы</button>
            </div>
        </nav>

        <!-- Content -->
        <main class="max-w-6xl mx-auto px-4 py-8">
            <!-- Profile Tab -->
            <section id="tab-profile" class="tab-content space-y-6">
                <h2 class="text-xl font-bold mb-4">Профиль</h2>

                <div class="bg-card-bg rounded-xl p-6 space-y-4">
                    <h3 class="font-semibold text-orange-accent">Фото</h3>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">URL фотографии</label>
                        <input type="text" id="profile-photo"
                            class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                    </div>
                    <div id="photoPreview" class="mt-2">
                        <img id="photoImg" src="" alt="Preview" class="w-32 h-32 object-cover rounded-xl hidden">
                    </div>
                </div>

                <div class="bg-card-bg rounded-xl p-6 space-y-4">
                    <h3 class="font-semibold text-orange-accent">Социальные сети</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">LinkedIn</label>
                            <input type="text" id="social-linkedin"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">GitHub</label>
                            <input type="text" id="social-github"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Telegram</label>
                            <input type="text" id="social-telegram"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Instagram</label>
                            <input type="text" id="social-instagram"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Email</label>
                            <input type="text" id="social-email"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Stats Tab -->
            <section id="tab-stats" class="tab-content hidden space-y-6">
                <h2 class="text-xl font-bold mb-4">Статистика</h2>

                <div class="bg-card-bg rounded-xl p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Лет опыта</label>
                            <input type="number" id="stats-years"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Проектов завершено</label>
                            <input type="number" id="stats-projects"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                    </div>
                </div>
            </section>

            <!-- Experience Tab -->
            <section id="tab-experience" class="tab-content hidden space-y-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Опыт работы</h2>
                    <button onclick="addExperience()"
                        class="bg-orange-accent text-white px-4 py-2 rounded-lg font-medium hover:opacity-90 transition">
                        + Добавить
                    </button>
                </div>

                <div id="experienceList" class="space-y-4"></div>
            </section>

            <!-- Skills Tab -->
            <section id="tab-skills" class="tab-content hidden space-y-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold">Навыки</h2>
                    <button onclick="addSkill()"
                        class="bg-orange-accent text-white px-4 py-2 rounded-lg font-medium hover:opacity-90 transition">
                        + Добавить
                    </button>
                </div>

                <div id="skillsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </section>

            <!-- Translations Tab -->
            <section id="tab-translations" class="tab-content hidden space-y-6">
                <h2 class="text-xl font-bold mb-4">Переводы</h2>

                <!-- Language selector -->
                <div class="flex gap-4 mb-6">
                    <button onclick="showTransLang('en')" id="trans-btn-en"
                        class="px-4 py-2 rounded-lg font-medium bg-orange-accent text-white">English</button>
                    <button onclick="showTransLang('ru')" id="trans-btn-ru"
                        class="px-4 py-2 rounded-lg font-medium bg-card-bg text-gray-400 hover:text-white">Русский</button>
                </div>

                <!-- EN Translations -->
                <div id="trans-en" class="space-y-6">
                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Профиль (EN)</h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Имя</label>
                            <input type="text" id="trans-en-profile-name"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Описание</label>
                            <textarea id="trans-en-profile-description"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none"></textarea>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Главная (EN)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 1</label>
                                <input type="text" id="trans-en-main-title1"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 2</label>
                                <input type="text" id="trans-en-main-title2"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Описание</label>
                            <textarea id="trans-en-main-description"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none"></textarea>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Статистика (EN)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Годы опыта (HTML)</label>
                                <input type="text" id="trans-en-stats-years"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Проекты (HTML)</label>
                                <input type="text" id="trans-en-stats-projects"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Опыт работы (EN)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 1</label>
                                <input type="text" id="trans-en-experience-title1"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 2</label>
                                <input type="text" id="trans-en-experience-title2"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                        <div id="trans-en-experience-items" class="space-y-4 mt-4"></div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Навыки (EN)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 1</label>
                                <input type="text" id="trans-en-skills-title1"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 2</label>
                                <input type="text" id="trans-en-skills-title2"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Футер (EN)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Made with</label>
                                <input type="text" id="trans-en-footer-made"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">by</label>
                                <input type="text" id="trans-en-footer-by"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Имя</label>
                                <input type="text" id="trans-en-footer-name"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RU Translations -->
                <div id="trans-ru" class="hidden space-y-6">
                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Профиль (RU)</h3>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Имя</label>
                            <input type="text" id="trans-ru-profile-name"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Описание</label>
                            <textarea id="trans-ru-profile-description"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none"></textarea>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Главная (RU)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 1</label>
                                <input type="text" id="trans-ru-main-title1"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 2</label>
                                <input type="text" id="trans-ru-main-title2"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Описание</label>
                            <textarea id="trans-ru-main-description"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none"></textarea>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Статистика (RU)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Годы опыта (HTML)</label>
                                <input type="text" id="trans-ru-stats-years"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Проекты (HTML)</label>
                                <input type="text" id="trans-ru-stats-projects"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Опыт работы (RU)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 1</label>
                                <input type="text" id="trans-ru-experience-title1"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 2</label>
                                <input type="text" id="trans-ru-experience-title2"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                        <div id="trans-ru-experience-items" class="space-y-4 mt-4"></div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Навыки (RU)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 1</label>
                                <input type="text" id="trans-ru-skills-title1"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Заголовок 2</label>
                                <input type="text" id="trans-ru-skills-title2"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="bg-card-bg rounded-xl p-6 space-y-4">
                        <h3 class="font-semibold text-orange-accent">Футер (RU)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Сделано с</label>
                                <input type="text" id="trans-ru-footer-made"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">by</label>
                                <input type="text" id="trans-ru-footer-by"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-2">Имя</label>
                                <input type="text" id="trans-ru-footer-name"
                                    class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 bg-card-bg border border-gray-700 rounded-lg px-6 py-4 hidden transform translate-y-full transition-transform duration-300">
        <p id="toastMessage" class="text-sm"></p>
    </div>

    <script>
        // Configuration
        const REPO_OWNER = 'iammaga';
        const REPO_NAME = 'CV';
        const FILE_PATH = 'data.json';

        // State
        let token = null;
        let currentData = null;
        let fileSha = null;

        // Login
        async function login() {
            const inputToken = document.getElementById('tokenInput').value.trim();
            if (!inputToken) {
                showError('Введите токен');
                return;
            }

            try {
                // Test token by fetching file
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    headers: {
                        'Authorization': `token ${inputToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Файл data.json не найден в репозитории. Сначала закоммитьте его.');
                    } else if (response.status === 401) {
                        throw new Error('Неверный токен');
                    } else if (response.status === 403) {
                        throw new Error('Токен не имеет прав доступа к репозиторию');
                    } else {
                        throw new Error(`Ошибка ${response.status}`);
                    }
                }

                const fileData = await response.json();
                fileSha = fileData.sha;
                // Правильное декодирование UTF-8 из base64
                const bytes = Uint8Array.from(atob(fileData.content), c => c.charCodeAt(0));
                const text = new TextDecoder('utf-8').decode(bytes);
                currentData = JSON.parse(text);

                // Store token in session
                token = inputToken;
                sessionStorage.setItem('github_token', token);

                // Show admin panel
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');

                // Populate forms
                populateForms();

            } catch (error) {
                showError('Ошибка авторизации: ' + error.message);
            }
        }

        function showError(message) {
            const errorEl = document.getElementById('loginError');
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function logout() {
            sessionStorage.removeItem('github_token');
            token = null;
            currentData = null;
            fileSha = null;
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('tokenInput').value = '';
        }

        // Tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('tab-active');
                el.classList.add('text-gray-400');
            });

            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-400');
        }

        function showTransLang(lang) {
            document.getElementById('trans-en').classList.toggle('hidden', lang !== 'en');
            document.getElementById('trans-ru').classList.toggle('hidden', lang !== 'ru');

            document.getElementById('trans-btn-en').classList.toggle('bg-orange-accent', lang === 'en');
            document.getElementById('trans-btn-en').classList.toggle('text-white', lang === 'en');
            document.getElementById('trans-btn-en').classList.toggle('bg-card-bg', lang !== 'en');
            document.getElementById('trans-btn-en').classList.toggle('text-gray-400', lang !== 'en');

            document.getElementById('trans-btn-ru').classList.toggle('bg-orange-accent', lang === 'ru');
            document.getElementById('trans-btn-ru').classList.toggle('text-white', lang === 'ru');
            document.getElementById('trans-btn-ru').classList.toggle('bg-card-bg', lang !== 'ru');
            document.getElementById('trans-btn-ru').classList.toggle('text-gray-400', lang !== 'ru');
        }

        // Populate forms with data
        function populateForms() {
            if (!currentData) return;

            // Profile
            document.getElementById('profile-photo').value = currentData.profile.photo || '';
            updatePhotoPreview();
            document.getElementById('social-linkedin').value = currentData.profile.social.linkedin || '';
            document.getElementById('social-github').value = currentData.profile.social.github || '';
            document.getElementById('social-telegram').value = currentData.profile.social.telegram || '';
            document.getElementById('social-instagram').value = currentData.profile.social.instagram || '';
            document.getElementById('social-email').value = currentData.profile.social.email || '';

            // Stats
            document.getElementById('stats-years').value = currentData.stats.years || 0;
            document.getElementById('stats-projects').value = currentData.stats.projects || 0;

            // Experience
            renderExperienceList();

            // Skills
            renderSkillsList();

            // Translations
            populateTranslations();
        }

        function updatePhotoPreview() {
            const url = document.getElementById('profile-photo').value;
            const img = document.getElementById('photoImg');
            if (url) {
                img.src = url;
                img.classList.remove('hidden');
            } else {
                img.classList.add('hidden');
            }
        }

        document.getElementById('profile-photo')?.addEventListener('input', updatePhotoPreview);

        // Experience CRUD
        function renderExperienceList() {
            const container = document.getElementById('experienceList');
            container.innerHTML = '';

            currentData.experience.forEach((exp, index) => {
                const div = document.createElement('div');
                div.className = 'bg-card-bg rounded-xl p-6 space-y-4';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-orange-accent">${exp.company}</h3>
                        <button onclick="removeExperience(${index})" class="text-red-500 hover:text-red-400 text-sm">Удалить</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">ID (для переводов)</label>
                            <input type="text" value="${exp.id}" onchange="updateExperience(${index}, 'id', this.value)"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-400 mb-2">Название компании</label>
                            <input type="text" value="${exp.company}" onchange="updateExperience(${index}, 'company', this.value)"
                                class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });

            // Update translations experience items
            renderExperienceTranslations();
        }

        function addExperience() {
            const id = 'new_' + Date.now();
            currentData.experience.push({ id: id, company: 'Новая компания' });

            // Add empty translations
            currentData.translations.en.experience[id] = '';
            currentData.translations.ru.experience[id] = '';

            renderExperienceList();
        }

        function removeExperience(index) {
            if (confirm('Удалить эту запись?')) {
                const id = currentData.experience[index].id;
                currentData.experience.splice(index, 1);

                // Remove translations
                delete currentData.translations.en.experience[id];
                delete currentData.translations.ru.experience[id];

                renderExperienceList();
            }
        }

        function updateExperience(index, field, value) {
            const oldId = currentData.experience[index].id;
            currentData.experience[index][field] = value;

            // If ID changed, update translation keys
            if (field === 'id' && oldId !== value) {
                currentData.translations.en.experience[value] = currentData.translations.en.experience[oldId] || '';
                currentData.translations.ru.experience[value] = currentData.translations.ru.experience[oldId] || '';
                delete currentData.translations.en.experience[oldId];
                delete currentData.translations.ru.experience[oldId];
                renderExperienceTranslations();
            }
        }

        // Skills CRUD
        function renderSkillsList() {
            const container = document.getElementById('skillsList');
            container.innerHTML = '';

            currentData.skills.forEach((skill, index) => {
                const div = document.createElement('div');
                div.className = 'bg-card-bg rounded-xl p-4 space-y-3';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <img src="${skill.iconUrl}" alt="${skill.name}" class="w-8 h-8">
                            <span class="font-medium">${skill.name}</span>
                        </div>
                        <button onclick="removeSkill(${index})" class="text-red-500 hover:text-red-400 text-sm">X</button>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Название</label>
                        <input type="text" value="${skill.name}" onchange="updateSkill(${index}, 'name', this.value)"
                            class="w-full bg-dark-bg border border-gray-700 rounded-lg px-3 py-1 text-sm focus:border-orange-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Icon ID</label>
                        <input type="text" value="${skill.icon}" onchange="updateSkill(${index}, 'icon', this.value)"
                            class="w-full bg-dark-bg border border-gray-700 rounded-lg px-3 py-1 text-sm focus:border-orange-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1">Icon URL</label>
                        <input type="text" value="${skill.iconUrl}" onchange="updateSkill(${index}, 'iconUrl', this.value)"
                            class="w-full bg-dark-bg border border-gray-700 rounded-lg px-3 py-1 text-sm focus:border-orange-accent focus:outline-none">
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addSkill() {
            currentData.skills.push({
                name: 'New Skill',
                icon: 'html',
                iconUrl: 'https://skillicons.dev/icons?i=html'
            });
            renderSkillsList();
        }

        function removeSkill(index) {
            if (confirm('Удалить этот навык?')) {
                currentData.skills.splice(index, 1);
                renderSkillsList();
            }
        }

        function updateSkill(index, field, value) {
            currentData.skills[index][field] = value;
            if (field === 'iconUrl') {
                renderSkillsList();
            }
        }

        // Translations
        function populateTranslations() {
            ['en', 'ru'].forEach(lang => {
                const t = currentData.translations[lang];

                document.getElementById(`trans-${lang}-profile-name`).value = t.profile.name || '';
                document.getElementById(`trans-${lang}-profile-description`).value = t.profile.description || '';

                document.getElementById(`trans-${lang}-main-title1`).value = t.main.title1 || '';
                document.getElementById(`trans-${lang}-main-title2`).value = t.main.title2 || '';
                document.getElementById(`trans-${lang}-main-description`).value = t.main.description || '';

                document.getElementById(`trans-${lang}-stats-years`).value = t.stats.years || '';
                document.getElementById(`trans-${lang}-stats-projects`).value = t.stats.projects || '';

                document.getElementById(`trans-${lang}-experience-title1`).value = t.experience.title1 || '';
                document.getElementById(`trans-${lang}-experience-title2`).value = t.experience.title2 || '';

                document.getElementById(`trans-${lang}-skills-title1`).value = t.skills.title1 || '';
                document.getElementById(`trans-${lang}-skills-title2`).value = t.skills.title2 || '';

                document.getElementById(`trans-${lang}-footer-made`).value = t.footer.made || '';
                document.getElementById(`trans-${lang}-footer-by`).value = t.footer.by || '';
                document.getElementById(`trans-${lang}-footer-name`).value = t.footer.name || '';
            });

            renderExperienceTranslations();
        }

        function renderExperienceTranslations() {
            ['en', 'ru'].forEach(lang => {
                const container = document.getElementById(`trans-${lang}-experience-items`);
                container.innerHTML = '';

                currentData.experience.forEach(exp => {
                    const div = document.createElement('div');
                    div.className = 'border-t border-gray-700 pt-4';
                    div.innerHTML = `
                        <label class="block text-sm text-gray-400 mb-2">${exp.company} (${exp.id})</label>
                        <textarea id="trans-${lang}-exp-${exp.id}"
                            class="w-full bg-dark-bg border border-gray-700 rounded-lg px-4 py-2 focus:border-orange-accent focus:outline-none"
                            rows="4">${currentData.translations[lang].experience[exp.id] || ''}</textarea>
                    `;
                    container.appendChild(div);
                });
            });
        }

        // Collect form data
        function collectFormData() {
            // Profile
            currentData.profile.photo = document.getElementById('profile-photo').value;
            currentData.profile.social.linkedin = document.getElementById('social-linkedin').value;
            currentData.profile.social.github = document.getElementById('social-github').value;
            currentData.profile.social.telegram = document.getElementById('social-telegram').value;
            currentData.profile.social.instagram = document.getElementById('social-instagram').value;
            currentData.profile.social.email = document.getElementById('social-email').value;

            // Stats
            currentData.stats.years = parseInt(document.getElementById('stats-years').value) || 0;
            currentData.stats.projects = parseInt(document.getElementById('stats-projects').value) || 0;

            // Translations
            ['en', 'ru'].forEach(lang => {
                currentData.translations[lang].profile.name = document.getElementById(`trans-${lang}-profile-name`).value;
                currentData.translations[lang].profile.description = document.getElementById(`trans-${lang}-profile-description`).value;

                currentData.translations[lang].main.title1 = document.getElementById(`trans-${lang}-main-title1`).value;
                currentData.translations[lang].main.title2 = document.getElementById(`trans-${lang}-main-title2`).value;
                currentData.translations[lang].main.description = document.getElementById(`trans-${lang}-main-description`).value;

                currentData.translations[lang].stats.years = document.getElementById(`trans-${lang}-stats-years`).value;
                currentData.translations[lang].stats.projects = document.getElementById(`trans-${lang}-stats-projects`).value;

                currentData.translations[lang].experience.title1 = document.getElementById(`trans-${lang}-experience-title1`).value;
                currentData.translations[lang].experience.title2 = document.getElementById(`trans-${lang}-experience-title2`).value;

                // Experience items
                currentData.experience.forEach(exp => {
                    const textarea = document.getElementById(`trans-${lang}-exp-${exp.id}`);
                    if (textarea) {
                        currentData.translations[lang].experience[exp.id] = textarea.value;
                    }
                });

                currentData.translations[lang].skills.title1 = document.getElementById(`trans-${lang}-skills-title1`).value;
                currentData.translations[lang].skills.title2 = document.getElementById(`trans-${lang}-skills-title2`).value;

                currentData.translations[lang].footer.made = document.getElementById(`trans-${lang}-footer-made`).value;
                currentData.translations[lang].footer.by = document.getElementById(`trans-${lang}-footer-by`).value;
                currentData.translations[lang].footer.name = document.getElementById(`trans-${lang}-footer-name`).value;
            });

            return currentData;
        }

        // Fetch latest SHA before saving
        async function getLatestSha() {
            const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            if (!response.ok) {
                throw new Error('Не удалось получить актуальную версию файла');
            }
            const fileData = await response.json();
            return fileData.sha;
        }

        // Save to GitHub
        async function saveData() {
            const saveBtn = document.getElementById('saveBtn');
            const saveLoader = document.getElementById('saveLoader');
            const saveStatus = document.getElementById('saveStatus');

            saveBtn.disabled = true;
            saveLoader.classList.remove('hidden');
            saveStatus.textContent = 'Сохранение...';

            try {
                // Получаем актуальный SHA перед сохранением
                fileSha = await getLatestSha();

                const data = collectFormData();
                const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: 'Update CV data via admin panel',
                        content: content,
                        sha: fileSha
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    if (response.status === 404) {
                        throw new Error('Файл не найден или токен не имеет прав на запись. Проверьте scope "repo" у токена.');
                    } else if (response.status === 401) {
                        throw new Error('Токен истёк или недействителен');
                    } else if (response.status === 403) {
                        throw new Error('Нет прав на запись. Токену нужен scope "repo"');
                    } else if (response.status === 409) {
                        throw new Error('Конфликт версий. Попробуйте ещё раз.');
                    } else {
                        throw new Error(error.message || `Ошибка ${response.status}`);
                    }
                }

                const result = await response.json();
                fileSha = result.content.sha;

                saveStatus.textContent = 'Сохранено!';
                showToast('Данные успешно сохранены!', 'success');

                setTimeout(() => {
                    saveStatus.textContent = '';
                }, 3000);

            } catch (error) {
                saveStatus.textContent = 'Ошибка!';
                showToast('Ошибка сохранения: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveLoader.classList.add('hidden');
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            toastMessage.textContent = message;
            toastMessage.className = type === 'error' ? 'text-red-400' : 'text-green-400';

            toast.classList.remove('hidden', 'translate-y-full');
            toast.classList.add('translate-y-0');

            setTimeout(() => {
                toast.classList.add('translate-y-full');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // Check for existing session
        window.addEventListener('DOMContentLoaded', async () => {
            const savedToken = sessionStorage.getItem('github_token');
            if (savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                await login();
            }
        });

        // Enter key on token input
        document.getElementById('tokenInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html>
